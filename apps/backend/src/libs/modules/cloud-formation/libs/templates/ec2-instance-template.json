{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Parameters": {
		"ImageId": {
			"Type": "String"
		},
		"MeetingId": {
			"Type": "String",
			"Description": "Meeting ID"
		},
		"MeetingPassword": {
			"Type": "String",
			"Description": "Meeting Password"
		}
	},
	"Resources": {
		"MeetlyticSecurityGroup": {
			"Type": "AWS::EC2::SecurityGroup",
			"Properties": {
				"GroupDescription": "Allow SSH access",
				"SecurityGroupIngress": [
					{
						"IpProtocol": "tcp",
						"FromPort": 22,
						"ToPort": 22,
						"CidrIp": "0.0.0.0/0"
					}
				],
				"Tags": [
					{
						"Key": "Name",
						"Value": "MeetlyticSecurityGroup"
					}
				]
			}
		},
		"EC2Instance": {
			"Type": "AWS::EC2::Instance",
			"Properties": {
				"ImageId": {
					"Ref": "ImageId"
				},
				"InstanceType": "t3.micro",
				"KeyName": "meetlytic-ssh",
				"SecurityGroupIds": [
					{
						"Ref": "MeetlyticSecurityGroup"
					}
				],
				"UserData": {
					"Fn::Base64": {
						"Fn::Sub": [
							"#!/bin/bash\n\n# --- 1. Install System Dependencies ---\nsudo apt update -y\nsudo apt install -y git\ncurl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -\nsudo apt install -y nodejs\n\n# Install Chromium shared libraries for Puppeteer\nsudo apt-get install -y libatk-bridge2.0-0 libgtk-3-0 libappindicator3-1 libnss3 libxss1 libasound2 libgbm1 libx11-xcb1 libxcomposite1 libxkbcommon0\n\n# --- 2. Clone the Repository and Switch Branch ---\ncd /home/ubuntu\ngit clone --branch 43-join-zoom-meetings-from-ec2 https://github.com/BinaryStudioAcademy/bsa-2025-meetlytic.git\n\n# --- 3. Install NPM Dependencies & Puppeteer Browser ---\ncd bsa-2025-meetlytic\n/usr/bin/npm install\n/usr/bin/npx puppeteer browsers install chrome\n\n# --- 4. Configure and Run the Bot ---\ncd apps/bot\n\necho \"NODE_ENV=production\" > .env\necho \"MEETING_ID=${MeetingId}\" >> .env\necho \"MEETING_PASSWORD=${MeetingPassword}\" >> .env\necho \"BOT_NAME=Meetlytic\" >> .env\n\nnohup /usr/bin/npm run start:dev > /home/ubuntu/bot.log 2>&1 &",
							{
								"MeetingId": {
									"Ref": "MeetingId"
								},
								"MeetingPassword": {
									"Ref": "MeetingPassword"
								}
							}
						]
					}
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": "MeetlyticEC2"
					}
				]
			}
		}
	},
	"Outputs": {
		"InstanceId": {
			"Value": {
				"Ref": "EC2Instance"
			},
			"Export": {
				"Name": "InstanceId"
			}
		}
	}
}
