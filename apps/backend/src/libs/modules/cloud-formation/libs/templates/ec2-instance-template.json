{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Parameters": {
		"ImageId": {
			"Type": "String"
		},
		"InstanceType": {
			"Type": "String",
			"Default": "t3.micro",
			"AllowedValues": [
				"t3.micro",
				"t3.small",
				"t3.medium",
				"t3.large",
				"t3.xlarge",
				"t3.2xlarge",
				"t2.micro",
				"t2.small",
				"t2.medium",
				"t4g.xlarge"
			],
			"Description": "EC2 instance type"
		},
		"Settings": {
			"Type": "String",
			"Description": "Object with meeting settings"
		}
	},
	"Resources": {
		"MeetlyticSecurityGroup": {
			"Type": "AWS::EC2::SecurityGroup",
			"Properties": {
				"GroupDescription": "Allow SSH access",
				"SecurityGroupIngress": [
					{
						"IpProtocol": "tcp",
						"FromPort": 22,
						"ToPort": 22,
						"CidrIp": "0.0.0.0/0"
					}
				],
				"Tags": [
					{
						"Key": "Name",
						"Value": "MeetlyticSecurityGroup"
					}
				]
			}
		},
		"EC2Instance": {
			"Type": "AWS::EC2::Instance",
			"Properties": {
				"ImageId": { "Ref": "ImageId" },
				"InstanceType": { "Ref": "InstanceType" },
				"KeyName": "meetlytic-ssh",
				"SecurityGroupIds": [{ "Ref": "MeetlyticSecurityGroup" }],
				"UserData": {
					"Fn::Base64": {
						"Fn::Sub": [
							"#!/bin/bash\n sudo apt update -y\n sudo apt install -y git\n cd /home/ubuntu\ngit clone --branch 232-fix-audio-chunking-logic-to-avoid-missing-words --single-branch https://github.com/BinaryStudioAcademy/bsa-2025-meetlytic.git\nsudo chown -R ubuntu:ubuntu /home/ubuntu/bsa-2025-meetlytic\ncd bsa-2025-meetlytic\nbash ./apps/bot/setup-ec2.sh '${Settings}'",
							{
								"Settings": {
									"Ref": "Settings"
								}
							}
						]
					}
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": "MeetlyticEC2"
					}
				]
			}
		}
	},
	"Outputs": {
		"InstanceId": {
			"Value": { "Ref": "EC2Instance" },
			"Export": {
				"Name": {
					"Fn::Sub": "InstanceId-${AWS::StackName}"
				}
			}
		}
	}
}
