{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Parameters": {
		"ImageId": {
			"Type": "String"
		},
		"MeetingId": {
			"Type": "String",
			"Description": "Meeting ID"
		},
		"MeetingPassword": {
			"Type": "String",
			"Description": "Meeting Password"
		}
	},
	"Resources": {
		"MeetlyticSecurityGroup": {
			"Type": "AWS::EC2::SecurityGroup",
			"Properties": {
				"GroupDescription": "Allow SSH access",
				"SecurityGroupIngress": [
					{
						"IpProtocol": "tcp",
						"FromPort": 22,
						"ToPort": 22,
						"CidrIp": "0.0.0.0/0"
					}
				],
				"Tags": [
					{
						"Key": "Name",
						"Value": "MeetlyticSecurityGroup"
					}
				]
			}
		},
		"EC2Instance": {
			"Type": "AWS::EC2::Instance",
			"Properties": {
				"ImageId": { "Ref": "ImageId" },
				"InstanceType": "t3.micro",
				"KeyName": "meetlytic-ssh",
				"SecurityGroupIds": [{ "Ref": "MeetlyticSecurityGroup" }],
				"UserData": {
					"Fn::Base64": {
						"Fn::Sub": [
							"#!/bin/bash\n sudo apt update -y\n sudo apt install -y git\n cd /home/ubuntu\ngit clone --branch 44-feat-record-audio-from-ec2 https://github.com/BinaryStudioAcademy/bsa-2025-meetlytic.git\ncd bsa-2025-meetlytic\nbash ./apps/bot/setup-ec2.sh ${MeetingId} ${MeetingPassword}",
							{
								"MeetingId": {
									"Ref": "MeetingId"
								},
								"MeetingPassword": {
									"Ref": "MeetingPassword"
								}
							}
						]
					}
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": "MeetlyticEC2"
					}
				]
			}
		}
	},
	"Outputs": {
		"InstanceId": {
			"Value": { "Ref": "EC2Instance" },
			"Export": { "Name": "InstanceId" }
		}
	}
}
